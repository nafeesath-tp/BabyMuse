{% extends 'core/base.html' %}
{% load static %}

{% block content %}
<div class="max-w-6xl mx-auto px-6 py-8 grid md:grid-cols-2 gap-8">

  <!-- Product Images -->
  <div>
    <!-- Breadcrumb -->
    <nav class="mb-4 text-sm text-gray-500">
      <a href="{% url 'home' %}" class="hover:text-pink-600">Home</a> /
      <a href="{% url 'shop:shop' %}" class="hover:text-pink-600">Shop</a> /
      <span class="text-pink-600 font-medium">{{ product.name }}</span>
    </nav>

    <!-- Zoomable Main Image -->
    <div class="border rounded-lg overflow-hidden mb-4 relative">
      <img id="main-image" src="{{ images.0.image.url }}" alt="{{ product.name }}"
        class="w-full h-[400px] object-contain transition-transform duration-300 ease-in-out"
        onmousemove="zoomImage(event)" onmouseleave="resetZoom()" />
    </div>

    <!-- Thumbnails -->
    <div class="flex gap-4">
      {% for image in images %}
      <img src="{{ image.image.url }}" alt="Thumb {{ forloop.counter }}"
        class="w-24 h-24 object-cover cursor-pointer border rounded-lg hover:ring-2 hover:ring-pink-500"
        onclick="changeMainImage('{{ image.image.url }}')" />
      {% endfor %}
    </div>
  </div>

  <!-- Product Info -->
  <div>
    <h1>{{ product.name }}</h1>

{% if product.price %}
  {% if final_discount|default:0 > 0 %}
    <p class="line-through text-gray-500">‚Çπ{{ product.price }}</p>
    <p class="text-green-600 font-bold">‚Çπ{{ discounted_price }} ({{ final_discount }}% OFF)</p>
  {% else %}
    <p class="font-bold text-pink-600">‚Çπ{{ product.price }}</p>
  {% endif %}
{% else %}
  <p class="text-red-500 text-sm mt-2">Price not available</p>
{% endif %}

    <!-- Rating -->
    <div class="flex items-center gap-2 mb-2">
      <div>
        {% for i in "12345" %}
        {% if avg_rating >= forloop.counter %}
        ‚≠ê
        {% elif avg_rating >= forloop.counter0|add:"0.5" %}
        ‚≠ê
        {% else %}
        ‚òÜ
        {% endif %}
        {% endfor %}
      </div>
      <span class="text-gray-600 text-sm">({{ total_reviews }} reviews)</span>
    </div>

    <!-- Price + Discount -->
    <div id="price-section">
 {% with first_variant=variants.0 %}
  {% if first_variant %}
    <div class="text-2xl text-pink-600 font-semibold">
      <span id="display-price">
        ‚Çπ{{ discounted_price }}
      </span>
    </div>
  {% else %}
    <p class="text-red-500 text-sm mt-2">Price not available</p>
  {% endif %}
{% endwith %}
    </div>

    <!-- Size Variants -->
{% if variants %}
<div class="mt-4 mb-4">
  <h3 class="text-lg font-medium mb-3 text-gray-800">Available Sizes:</h3>
  <div class="flex flex-wrap gap-2">
    {% for variant in variants %}
    <label class="cursor-pointer">
      <input 
        type="radio" 
        name="size_variant" 
        value="{{ variant.id }}" 
        class="hidden size-variant-radio" 
        data-price="{{ variant.price }}"
        data-stock="{{ variant.stock }}"
        data-size="{{ variant.size }}"
        {% if forloop.first %}checked{% endif %}
        {% if variant.stock <= 0 %}disabled{% endif %}
      >
      <span class="inline-block px-4 py-2 border border-gray-300 rounded-lg text-sm font-medium
                    hover:border-pink-500 hover:bg-pink-50 transition-colors
                    variant-option {% if variant.stock <= 0 %}opacity-50 cursor-not-allowed{% endif %}"
            data-variant-id="{{ variant.id }}" 
            data-stock="{{ variant.stock }}">
        {{ variant.size }}
        {% if variant.stock <= 0 %}
          <span class="text-xs text-red-500 block">Out of Stock</span>
        {% elif variant.stock <= 10 %}
          <span class="text-xs text-orange-500 block">Only {{ variant.stock }} left</span>
        {% endif %}
      </span>
    </label>
    {% endfor %}
  </div>

  <!-- Selected variant info -->
  <div id="selected-variant-info" class="mt-2 text-sm text-gray-600">
    Selected: <span id="selected-variant-name">{{ variants.0.size }}</span>
    <span id="selected-variant-stock" class="ml-2">
      {% if variants.0.stock <= 0 %}
        (<span class="text-red-500">Out of Stock</span>)
      {% elif variants.0.stock <= 10 %}
        (<span class="text-orange-500">Only {{ variants.0.stock }} left</span>)
      {% else %}
        (In Stock)
      {% endif %}
    </span>
  </div>
</div>
{% endif %}

    <!-- Stock Status Alert -->
    <div id="stock-alert" class="mt-4 mb-4 hidden">
      <div class="p-4 bg-red-100 border-l-4 border-red-500 text-red-700">
        ‚ö†Ô∏è <span id="stock-message">This size is currently out of stock.</span>
      </div>
    </div>

    <!-- Low Stock Alert -->
    <div id="low-stock-alert" class="mt-4 mb-4 hidden">
      <div class="p-4 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700">
        ‚ö†Ô∏è <span id="low-stock-message">Only few items left in stock!</span>
      </div>
    </div>

    <!-- Description -->
    <p class="mt-4 text-gray-700 leading-relaxed">{{ product.description }}</p>

    <!-- Action Buttons -->
    <div class="flex gap-4 mt-6">
      <button id="add-to-cart-btn" class="bg-green-600 text-white px-5 py-2 rounded hover:bg-green-700 transition disabled:bg-gray-400 disabled:cursor-not-allowed"
        data-product-id="{{ product.id }}">üõí Add to Cart</button>

      <button id="add-to-wishlist-btn" class="bg-pink-500 text-white px-5 py-2 rounded hover:bg-pink-600 transition"
        data-product-id="{{ product.id }}" data-variant-id="{{ selected_variant.id }}">‚ù§Ô∏è Add to Wishlist</button>
    </div>
  </div>
</div>

<!-- Toast -->
<div id="toast"
  class="fixed top-5 right-5 px-4 py-2 rounded shadow hidden z-50 bg-green-100 text-green-800 border border-green-400">
</div>

<!-- Product Reviews Section -->
<div class="max-w-6xl mx-auto px-6 mt-10 border-t pt-6">

  <h2 class="text-xl font-semibold mb-4">Customer Reviews ({{ total_reviews }})</h2>

  <!-- Average Rating -->
  <div class="flex items-center gap-2 mb-4">
    <div>
      {% for i in "12345" %}
        {% if avg_rating >= forloop.counter %}
          ‚≠ê
        {% elif avg_rating >= forloop.counter0|add:"0.5" %}
          ‚≠ê
        {% else %}
          ‚òÜ
        {% endif %}
      {% endfor %}
    </div>
    <span class="text-gray-600 text-sm">
      Average Rating: {{ avg_rating|default:"0"|floatformat:1 }} / 5
    </span>
  </div>

  <!-- Existing Reviews -->
  <div id="reviews-list" class="space-y-4 mb-6">
    {% for review in reviews %}
      <div class="border rounded p-3">
        <div class="flex justify-between items-center mb-1">
          <strong>{{ review.user.email }}</strong>
          <span class="text-yellow-500">
            {% for i in "12345" %}
              {% if review.rating >= forloop.counter %}
                ‚≠ê
              {% else %}
                ‚òÜ
              {% endif %}
            {% endfor %}
          </span>
        </div>
        <p class="text-gray-700">{{ review.comment }}</p>
        <small class="text-gray-500">{{ review.created_at|date:"M d, Y H:i" }}</small>
      </div>
    {% empty %}
      <p class="text-gray-500">No reviews yet. Be the first to review!</p>
    {% endfor %}
  </div>

  <!-- Review Form with Hoverable Star Rating -->
  {% if user.is_authenticated %}
    <h3 class="text-lg font-medium mb-2">Write a Review</h3>
    <form method="post">
      {% csrf_token %}
      
      <!-- Star Rating -->
      <div class="flex items-center gap-2 mb-2">
        <label class="text-gray-700">Rating:</label>
        <div id="star-rating" class="flex gap-1 cursor-pointer">
          {% for i in "12345" %}
            <span class="star text-gray-400 text-xl" data-value="{{ forloop.counter }}">‚òÜ</span>
          {% endfor %}
        </div>
        {{ review_form.rating.as_hidden }}
      </div>
      
      <!-- Comment -->
      <div class="mb-2">
        {{ review_form.comment }}
      </div>
      
      <button type="submit" class="bg-pink-500 text-white px-4 py-2 rounded hover:bg-pink-600 transition">
        Submit Review
      </button>
    </form>

    <script>
      document.addEventListener("DOMContentLoaded", function() {
        const stars = document.querySelectorAll("#star-rating .star");
        const ratingInput = document.getElementById("id_rating");
        let currentRating = 0;

        stars.forEach((star) => {
          star.addEventListener("mouseover", function() {
            const value = parseInt(this.dataset.value);
            stars.forEach((s, i) => {
              s.textContent = i < value ? "‚≠ê" : "‚òÜ";
              s.classList.toggle("text-yellow-500", i < value);
              s.classList.toggle("text-gray-400", i >= value);
            });
          });

          star.addEventListener("mouseout", function() {
            stars.forEach((s, i) => {
              s.textContent = i < currentRating ? "‚≠ê" : "‚òÜ";
              s.classList.toggle("text-yellow-500", i < currentRating);
              s.classList.toggle("text-gray-400", i >= currentRating);
            });
          });

          star.addEventListener("click", function() {
            currentRating = parseInt(this.dataset.value);
            ratingInput.value = currentRating;

            stars.forEach((s, i) => {
              s.textContent = i < currentRating ? "‚≠ê" : "‚òÜ";
              s.classList.toggle("text-yellow-500", i < currentRating);
              s.classList.toggle("text-gray-400", i >= currentRating);
            });
          });
        });
      });
    </script>
  {% else %}
    <p class="text-gray-600 mt-2">
      <a href="{% url 'user:user_login' %}" class="text-pink-600 hover:underline">Login</a> to write a review.
    </p>
  {% endif %}
</div>

<!-- Zoom + AJAX Logic -->
<script>
  function changeMainImage(url) {
    const img = document.getElementById("main-image");
    img.src = url;
    img.style.transform = "scale(1)";
  }

  function zoomImage(e) {
    const img = e.target;
    const rect = img.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const y = e.clientY - rect.top;
    const xPercent = x / rect.width * 100;
    const yPercent = y / rect.height * 100;
    img.style.transformOrigin = `${xPercent}% ${yPercent}%`;
    img.style.transform = "scale(2)";
  }

  function resetZoom() {
    const img = document.getElementById("main-image");
    img.style.transform = "scale(1)";
  }

  function showToast(message, success = true) {
    const toast = document.getElementById("toast");
    toast.innerText = message;
    toast.className = `fixed top-5 right-5 px-4 py-2 rounded shadow z-50 ${success ? 'bg-green-100 text-green-800 border-green-400' : 'bg-red-100 text-red-800 border-red-400'}`;
    toast.classList.remove("hidden");
    setTimeout(() => toast.classList.add("hidden"), 3000);
  }

  function updateStockStatus(stock, variantName) {
    const stockAlert = document.getElementById("stock-alert");
    const lowStockAlert = document.getElementById("low-stock-alert");
    const cartBtn = document.getElementById("add-to-cart-btn");
    const stockMessage = document.getElementById("stock-message");
    const lowStockMessage = document.getElementById("low-stock-message");

    stockAlert.classList.add("hidden");
    lowStockAlert.classList.add("hidden");

    if (stock <= 0) {
      stockAlert.classList.remove("hidden");
      stockMessage.textContent = `${variantName} is currently out of stock.`;
      cartBtn.disabled = true;
      cartBtn.classList.add("disabled:bg-gray-400", "disabled:cursor-not-allowed");
    } else if (stock <= 5) {
      lowStockAlert.classList.remove("hidden");
      lowStockMessage.textContent = `Only ${stock} items left for ${variantName}!`;
      cartBtn.disabled = false;
      cartBtn.classList.remove("disabled:bg-gray-400", "disabled:cursor-not-allowed");
    } else {
      cartBtn.disabled = false;
      cartBtn.classList.remove("disabled:bg-gray-400", "disabled:cursor-not-allowed");
    }
  }

  function updatePrice(variant) {
    const displayPrice = document.getElementById("display-price");
    const displayDiscountPrice = document.getElementById("display-discount-price");
    const displayOriginalPrice = document.getElementById("display-original-price");

    if (variant.dataset.discountPrice && variant.dataset.discountPrice !== 'None' && variant.dataset.discountPrice !== '') {
      if (displayDiscountPrice) {
        displayDiscountPrice.textContent = variant.dataset.discountPrice;
      }
      if (displayOriginalPrice) {
        displayOriginalPrice.textContent = variant.dataset.price;
      }
    } else {
      if (displayPrice) {
        displayPrice.textContent = variant.dataset.price;
      }
    }
  }

  // --- CSRF from cookie (reliable in Django) ---
  function getCookie(name) {
    const value = `; ${document.cookie}`;
    const parts = value.split(`; ${name}=`);
    if (parts.length === 2) return parts.pop().split(';').shift();
    return null;
  }
  const csrftoken = getCookie('csrftoken');

  // --- Wishlist Count Helper (updates header without refresh) ---
  function bumpWishlistCount(delta) {
    const el = document.getElementById('wishlist-count'); // put this id in your header badge
    if (!el) return;
    const current = parseInt(el.textContent) || 0;
    const next = Math.max(0, current + delta);
    el.textContent = String(next);
    el.classList.remove('hidden');
  }

  document.addEventListener("DOMContentLoaded", function () {
    const variantRadios = document.querySelectorAll('.size-variant-radio');
    const variantOptions = document.querySelectorAll('.variant-option');
    const selectedVariantName = document.getElementById('selected-variant-name');
    const selectedVariantStock = document.getElementById('selected-variant-stock');
    const cartBtn = document.getElementById("add-to-cart-btn");
    const wishlistBtn = document.getElementById("add-to-wishlist-btn");

    // Initialize first variant if exists
    if (variantRadios.length > 0) {
      const firstVariant = variantRadios[0];
      const firstOption = variantOptions[0];
      
      firstOption.classList.remove('border-gray-300');
      firstOption.classList.add('border-pink-500', 'bg-pink-50', 'text-pink-700');
      
      // FIX: use dataset.size (you set data-size on radios)
      updateStockStatus(parseInt(firstVariant.dataset.stock), firstVariant.dataset.size);
      updatePrice(firstVariant);
      
      if (selectedVariantStock) {
        const stock = parseInt(firstVariant.dataset.stock);
        if (stock <= 0) {
          selectedVariantStock.innerHTML = '<span class="text-red-500">(Out of Stock)</span>';
        } else if (stock <= 5) {
          selectedVariantStock.innerHTML = `<span class="text-orange-500">(${stock} left)</span>`;
        } else {
          selectedVariantStock.innerHTML = `<span class="text-green-500">(In Stock)</span>`;
        }
      }
    }

    // Handle variant option clicks
    variantOptions.forEach((option, index) => {
      option.addEventListener('click', function() {
        const stock = parseInt(this.dataset.stock);
        if (stock <= 0) {
          showToast("This size is out of stock!", false);
          return;
        }

        variantOptions.forEach(opt => {
          opt.classList.remove('border-pink-500', 'bg-pink-50', 'text-pink-700');
          opt.classList.add('border-gray-300');
        });
        
        this.classList.remove('border-gray-300');
        this.classList.add('border-pink-500', 'bg-pink-50', 'text-pink-700');
        
        const radio = variantRadios[index];
        radio.checked = true;
        
        if (selectedVariantName) {
          // FIX: use dataset.size
          selectedVariantName.textContent = radio.dataset.size;
        }
        
        if (selectedVariantStock) {
          if (stock <= 0) {
            selectedVariantStock.innerHTML = '<span class="text-red-500">(Out of Stock)</span>';
          } else if (stock <= 5) {
            selectedVariantStock.innerHTML = `<span class="text-orange-500">(${stock} left)</span>`;
          } else {
            selectedVariantStock.innerHTML = '<span class="text-green-500">(In Stock)</span>';
          }
        }
        
        // FIX: use dataset.size
        updateStockStatus(stock, radio.dataset.size);
        updatePrice(radio);
      });
    });

    // Cart button functionality (use CSRF from cookie)
    if (cartBtn) {
      cartBtn.addEventListener("click", function () {
        if (this.disabled) {
          showToast("Please select an available size!", false);
          return;
        }

        const productId = this.dataset.productId;
        const selectedVariant = document.querySelector('input[name="size_variant"]:checked');
        
        if (selectedVariant) {
          const stock = parseInt(selectedVariant.dataset.stock);
          if (stock <= 0) {
            showToast("Selected size is out of stock!", false);
            return;
          }
        }
        
        let body = `product_id=${encodeURIComponent(productId)}`;
        if (selectedVariant) {
          body += `&variant_id=${encodeURIComponent(selectedVariant.value)}`;
        }
        
        fetch("{% url 'shop:ajax_add_to_cart' %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": csrftoken,
            "Accept": "application/json",
            "Content-Type": "application/x-www-form-urlencoded"
          },
          credentials: "same-origin",
          body
        })
        .then(res => res.json())
        .then(data => {
          if (!data) return;

          if (data.status === "login_required" && data.redirect_url){
            window.location.href = data.redirect_url + '?next=' + window.location.pathname;
            return;
          }
          if (data.status === "success"){
            showToast(data.message);
          } else if (data.status === "error"){
            showToast(data.message || "Add to cart has been failed.", false);
          }
        })
        .catch(() => {
          showToast("An error occurred. Please try again.", false);
        });
      });
    }

    // --- Wishlist button: update UI WITHOUT refresh ---
    if (wishlistBtn) {
      wishlistBtn.addEventListener("click", function () {
        const productId = this.dataset.productId;
        const selectedVariant = document.querySelector('input[name="size_variant"]:checked');
        
        let body = `product_id=${encodeURIComponent(productId)}`;
        if (selectedVariant) {
          body += `&variant_id=${encodeURIComponent(selectedVariant.value)}`;
        }
        
        fetch("{% url 'shop:ajax_add_to_wishlist' %}", {
          method: "POST",
          headers: {
            "X-CSRFToken": csrftoken,
            "Accept": "application/json",
            "Content-Type": "application/x-www-form-urlencoded"
          },
          credentials: "same-origin",
          body
        })
        .then(async (res) => {
          // If server redirected (e.g., to login), go there
          if (res.redirected) {
            window.location.href = res.url;
            return null;
          }
          // Handle 401/403 (not logged in)
          if (res.status === 401 || res.status === 403) {
            window.location.href = "{% url 'user:user_login' %}" + '?next=' + window.location.pathname;
            return null;
          }
          // Try to parse JSON
          try {
            return await res.json();
          } catch {
            return null;
          }
        })
        .then((data) => {
          if (!data) return;

          // Expecting: {status: 'added' | 'exists' | 'removed', count: <optional new count> }
          if (data.status === 'added') {
            // update count if provided, else +1
            if (typeof data.count === 'number') {
              const el = document.getElementById('wishlist-count');
              if (el) { el.textContent = String(data.count); el.classList.remove('hidden'); }
            } else {
              bumpWishlistCount(1);
            }
            // update button instantly
            wishlistBtn.textContent = '‚ù§Ô∏è In Wishlist';
            wishlistBtn.classList.add('opacity-80');
            wishlistBtn.setAttribute('aria-pressed', 'true');
            showToast("Added to wishlist!");
          } else if (data.status === 'removed') {
            if (typeof data.count === 'number') {
              const el = document.getElementById('wishlist-count');
              if (el) { el.textContent = String(data.count); el.classList.remove('hidden'); }
            } else {
              bumpWishlistCount(-1);
            }
            wishlistBtn.textContent = '‚ù§Ô∏è Add to Wishlist';
            wishlistBtn.classList.remove('opacity-80');
            wishlistBtn.setAttribute('aria-pressed', 'false');
            showToast("Removed from wishlist");
          } else if (data.status === 'exists') {
            // already there: still reflect state in UI
            wishlistBtn.textContent = '‚ù§Ô∏è In Wishlist';
            wishlistBtn.classList.add('opacity-80');
            wishlistBtn.setAttribute('aria-pressed', 'true');
            showToast("Already in wishlist", false);
          } else {
            showToast("Could not update wishlist.", false);
          }
        })
        .catch(() => {
          showToast("An error occurred. Please try again.", false);
        });
      });
    }
  });
</script>
{% endblock %}
